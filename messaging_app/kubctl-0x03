#!/bin/bash

echo "ğŸš€ Starting rolling update to image version 2.0..."

# Apply updated deployment
kubectl apply -f blue_deployment.yaml

# Monitor rollout status
echo "â³ Watching rollout progress..."
kubectl rollout status deployment/messaging-app-blue

# Run curl in background while rollout is happening
echo "ğŸ“¡ Testing app availability during rollout..."

SERVICE_IP=$(minikube ip)
for i in {1..10}; do
  curl -s http://$SERVICE_IP:8000/ >> rollout_log.txt
  echo " ğŸ” Request $i sent"
  sleep 1
done

# Check the new pods after update
echo "ğŸ” Checking updated pods..."
kubectl get pods -l version=blue